esphome:
  name: ${esphome_name}

#==========================================================================================================================
# Scripts to update bar displays so that either new thresholds or new values trigger the same code

script: 
  - id : update_bar_pm2_5
    then:
      - lvgl.label.update:
        # Update displayed text value
          id: lbl_bar_pm2_5
          text: 
            format: "PM2.5: %.0f"
            args: [ 'id(pm2_5).state' ]
      - lvgl.label.update:
        # Update displayed max value
          id: lbl_bar_pm2_5_max
          text:
            format: "%.0f" #Float but display only integer part
            args: [ 'id(pm2_5_max).state' ]
      - lvgl.bar.update:
        # Update bar value itself
          id: bar_pm2_5
          value: !lambda |- 
            return (static_cast<int>(round((id(pm2_5).state)/(id(pm2_5_max).state)*100))); // scale value to 0-100 from 0-max
        # Update displayed bar colour
          indicator:
            bg_color: !lambda |-
              if (isnan(id(pm2_5).state)) return lv_color_hex(0x808080); //Grey
              if ((id(pm2_5).state)<(id(pm2_5_warn).state)) return lv_color_hex(0x00FF00); //Green
              if ((id(pm2_5).state)<(id(pm2_5_alarm).state)) return lv_color_hex(0xFF8000); //Orange
              return lv_color_hex(0xFF0000); //Red
      - script.execute: update_alarm_LED

  - id : update_bar_pm10
    then:
      - lvgl.label.update:
        # Update displayed text value
          id: lbl_bar_pm10
          text: 
            format: "PM10: %.0f"
            args: [ 'id(pm10).state' ]
      - lvgl.label.update:
        # Update displayed max value
          id: lbl_bar_pm10_max
          text:
            format: "%.0f" #Float but display only integer part
            args: [ 'id(pm10_max).state' ]
      - lvgl.bar.update:
        # Update bar value itself
          id: bar_pm10
          value: !lambda |- 
            return (static_cast<int>(round((id(pm10).state)/(id(pm10_max).state)*100))); // scale value to 0-100 from 0-max
        # Update displayed bar colour
          indicator:
            bg_color: !lambda |-
              if (isnan(id(pm10).state)) return lv_color_hex(0x808080); //Grey
              if ((id(pm10).state)<(id(pm10_warn).state)) return lv_color_hex(0x00FF00); //Green
              if ((id(pm10).state)<(id(pm10_alarm).state)) return lv_color_hex(0xFF8000); //Orange
              return lv_color_hex(0xFF0000); //Red
      - script.execute: update_alarm_LED

  - id : update_bar_no2
    then:
  #     - lvgl.label.update:
  #       # Update displayed text value
  #         id: lbl_bar_no2
  #         text: 
  #           format: "NO2: %.0f"
  #           args: [ 'id(no2).state' ]
  #     - lvgl.label.update:
  #       # Update displayed max value
  #         id: lbl_bar_no2_max
  #         text:
  #           format: "%.0f" #Float but display only integer part
  #           args: [ 'id(no2_max).state' ]
  #     - lvgl.bar.update:
  #       # Update bar value itself
  #         id: bar_no2
  #         value: !lambda |- 
  #           return (static_cast<int>(round((id(no2).state)/(id(no2_max).state)*100))); // scale value to 0-100 from 0-max
  #       # Update displayed bar colour
  #         indicator:
  #           bg_color: !lambda |-
  #             if (isnan(id(no2).state)) return lv_color_hex(0x808080); //Grey
  #             if ((id(no2).state)<(id(no2_warn).state)) return lv_color_hex(0x00FF00); //Green
  #             if ((id(no2).state)<(id(no2_alarm).state)) return lv_color_hex(0xFF8000); //Orange
  #             return lv_color_hex(0xFF0000); //Red
  #     - script.execute: update_alarm_LED

  - id : update_bar_co
    then:
  #     - lvgl.label.update:
  #       # Update displayed text value
  #         id: lbl_bar_co
  #         text: 
  #           format: "CO: %.0f"
  #           args: [ 'id(co).state' ]
  #     - lvgl.label.update:
  #       # Update displayed max value
  #         id: lbl_bar_co_max
  #         text:
  #           format: "%.0f" #Float but display only integer part
  #           args: [ 'id(co_max).state' ]
  #     - lvgl.bar.update:
  #       # Update bar value itself
  #         id: bar_co
  #         value: !lambda |- 
  #           return (static_cast<int>(round((id(co).state)/(id(co_max).state)*100))); // scale value to 0-100 from 0-max
  #       # Update displayed bar colour
  #         indicator:
  #           bg_color: !lambda |-
  #             if (isnan(id(co).state)) return lv_color_hex(0x808080); //Grey
  #             if ((id(co).state)<(id(co_warn).state)) return lv_color_hex(0x00FF00); //Green
  #             if ((id(co).state)<(id(co_alarm).state)) return lv_color_hex(0xFF8000); //Orange
  #             return lv_color_hex(0xFF0000); //Red
  #     - script.execute: update_alarm_LED

  - id : update_bar_co2
    then:
      - lvgl.label.update:
        # Update displayed text value
          id: lbl_bar_co2
          text: 
            format: "CO2: %.0f"
            args: [ 'id(co2).state' ]
      - lvgl.label.update:
        # Update displayed max value
          id: lbl_bar_co2_max
          text:
            format: "%.0f" #Float but display only integer part
            args: [ 'id(co2_max).state' ]
      - lvgl.bar.update:
        # Update bar value itself
          id: bar_co2
          value: !lambda |- 
            return (static_cast<int>(round((id(co2).state)/(id(co2_max).state)*100))); // scale value to 0-100 from 0-max
        # Update displayed bar colour
          indicator:
            bg_color: !lambda |-
              if (isnan(id(co2).state)) return lv_color_hex(0x808080); //Grey
              if ((id(co2).state)<(id(co2_warn).state)) return lv_color_hex(0x00FF00); //Green
              if ((id(co2).state)<(id(co2_alarm).state)) return lv_color_hex(0xFF8000); //Orange
              return lv_color_hex(0xFF0000); //Red
      - script.execute: update_alarm_LED

  - id : update_bar_co2b
    then:
      - lvgl.label.update:
        # Update displayed text value
          id: lbl_bar_co2b
          text: 
            format: "CO2: %.0f"
            args: [ 'id(bme68x_co2equivalent).state' ]
      - lvgl.label.update:
        # Update displayed max value
          id: lbl_bar_co2b_max
          text:
            format: "%.0f" #Float but display only integer part
            args: [ 'id(co2_max).state' ]
      - lvgl.bar.update:
        # Update bar value itself
          id: bar_co2b
          value: !lambda |- 
            return (static_cast<int>(round((id(bme68x_co2equivalent).state)/(id(co2_max).state)*100))); // scale value to 0-100 from 0-max
        # Update displayed bar colour
          indicator:
            bg_color: !lambda |-
              if (isnan(id(bme68x_co2equivalent).state)) return lv_color_hex(0x808080); //Grey
              if ((id(bme68x_co2equivalent).state)<(id(co2_warn).state)) return lv_color_hex(0x00FF00); //Green
              if ((id(bme68x_co2equivalent).state)<(id(co2_alarm).state)) return lv_color_hex(0xFF8000); //Orange
              return lv_color_hex(0xFF0000); //Red
      - script.execute: update_alarm_LED

  - id : update_bar_nh3
    then:
    #   - lvgl.label.update:
    #     # Update displayed text value
    #       id: lbl_bar_nh3
    #       text: 
    #         format: "NH3: %.0f"
    #         args: [ 'id(nh3).state' ]
    #   - lvgl.label.update:
    #     # Update displayed max value
    #       id: lbl_bar_nh3_max
    #       text:
    #         format: "%.0f" #Float but display only integer part
    #         args: [ 'id(nh3_max).state' ]
    #   - lvgl.bar.update:
    #     # Update bar value itself
    #       id: bar_nh3
    #       value: !lambda |- 
    #         return (static_cast<int>(round((id(nh3).state)/(id(nh3_max).state)*100))); // scale value to 0-100 from 0-max
    #     # Update displayed bar colour
    #       indicator:
    #         bg_color: !lambda |-
    #           if (isnan(id(nh3).state)) return lv_color_hex(0x808080); //Grey
    #           if ((id(nh3).state)<(id(nh3_warn).state)) return lv_color_hex(0x00FF00); //Green
    #           if ((id(nh3).state)<(id(nh3_alarm).state)) return lv_color_hex(0xFF8000); //Orange
    #           return lv_color_hex(0xFF0000); //Red
    #   - script.execute: update_alarm_LED

  - id : update_alarm_LED
    then: 
      - if:
          condition:
            or:
              - lambda: 'return (id(pm2_5).state) > (id(pm2_5_alarm).state);'
              - lambda: 'return (id(pm10).state) > (id(pm10_alarm).state);'
              # - lambda: 'return (id(no2).state) > (id(no2_alarm).state);'
              # - lambda: 'return (id(co).state) > (id(co_alarm).state);'
              - lambda: 'return (id(co2).state) > (id(co2_alarm).state);'
              - lambda: 'return (id(bme68x_co2equivalent).state) > (id(co2_alarm).state);'
#              - lambda: 'return (id(nh3).state) > (id(nh3_alarm).state);'
          then:
            - light.turn_on: 
                id: side_light
                effect: "Alarm Pulse"
                red: 100%
                green: 0%
                blue: 0%
          else:
            - if:
                condition:
                  or:
                    - lambda: 'return (id(pm2_5).state) > (id(pm2_5_warn).state);'
                    - lambda: 'return (id(pm10).state) > (id(pm10_warn).state);'
                    # - lambda: 'return (id(no2).state) > (id(no2_warn).state);'
                    # - lambda: 'return (id(co).state) > (id(co_warn).state);'
                    - lambda: 'return (id(co2).state) > (id(co2_warn).state);'
                    - lambda: 'return (id(bme68x_co2equivalent).state) > (id(co2_warn).state);'
#                    - lambda: 'return (id(nh3).state) > (id(nh3_warn).state);'
                then:
                  - light.turn_on: 
                      id: side_light
                      effect: "Warn Pulse"
                      red: 100%
                      green: 50%
                      blue: 0%
                else:
                  - light.turn_off: side_light

#==========================================================================================================================
lvgl:
  # encoders:
  #   enter_button: M5_BtnB
  #   sensor: 
  #     left_button: M5_BtnA
  #     right_button: M5_BtnC

  theme:
    label:
      text_font: montserrat_18 # set all your labels to use your custom defined font
    button:
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      bg_grad_dir: VER
      bg_opa: COVER
      border_color: 0x0077b3
      border_width: 1
      text_color: 0xFFFFFF
      pressed: # set some button colors to be different in pressed state
        bg_color: 0x006699
        bg_grad_color: 0x00334d
      checked: # set some button colors to be different in checked state
        bg_color: 0x1d5f96
        bg_grad_color: 0x03324A
        text_color: 0xfff300
      focused:
#        bg_color: 0x00cc00
        border_color: 0xff0000
#        bg_grad_dir: NONE
        border_width: 4
    buttonmatrix:
      bg_opa: COVER
      # bg_opa: TRANSP
      border_color: 0x0077b3
      border_width: 2 #Must be same border width focussed and non-focussed otherwise buttons shift up from screen bottom when focussed
      text_color: 0xFFFFFF
      pad_all: 0
      focused:
        # bg_color: 0x00cc00
        border_color: 0xff0000
        # bg_grad_dir: NONE
        border_width: 2
      items: # set all your buttonmatrix buttons to use your custom defined styles and font
        # bg_color: 0x2F8CD8
        # bg_grad_color: 0x005782
        # bg_grad_dir: VER
        # bg_opa: COVER
        # border_color: 0x0077b3
        # border_width: 1
        # text_color: 0xFFFFFF
        # text_font: montserrat_14
        pressed:
          bg_color: 0x006699
          bg_grad_color: 0x00334d
        checked:
          bg_color: 0x1d5f96
          bg_grad_color: 0x03324A
          text_color: 0x005580
        focused:
          bg_color: 0x00cc00
          border_color: 0xff0000
          bg_opa: COVER
          bg_grad_dir: NONE
          border_width: 2
          border_post: true #Draw border after all children have been rendered
    switch:
      bg_color: 0xC0C0C0
      bg_grad_color: 0xb0b0b0
      bg_grad_dir: VER
      bg_opa: COVER
      focused:
        # bg_color: 0x00cc00
        border_color: 0xff0000
        # bg_grad_dir: NONE
        border_width: 2
      checked:
        bg_color: 0x1d5f96
        bg_grad_color: 0x03324A
        bg_grad_dir: VER
        bg_opa: COVER
      knob:
        bg_color: 0xFFFFFF
        bg_grad_color: 0xC0C0C0
        bg_grad_dir: VER
        bg_opa: COVER
    slider:
      border_width: 1
      border_opa: COVER
      bg_color: 0xcccaca
      bg_opa: COVER
      pad_all: 0
      pressed: #Occurs momentarily when changed value is accepted
        border_color: 0xff0000
        # bg_grad_dir: NONE
        border_width: 4
        border_opa: COVER
        bg_color: 0x00cc00 #only affects the background not covered by indicator bar
      focused:
        border_color: 0xff0000
        # bg_grad_dir: NONE
        border_width: 2
        border_opa: COVER
      indicator:
        bg_color: 0x1d5f96
        bg_grad_color: 0x03324A
        bg_grad_dir: VER
        bg_opa: COVER
        focused:
          # bg_color: 0x00cc00
          border_color: 0xff0000
          # bg_grad_dir: NONE
          border_width: 2
      knob:
        bg_color: 0x2F8CD8
        bg_grad_color: 0x005782
        bg_grad_dir: VER
        bg_opa: COVER
        border_color: 0x0077b3
        border_width: 1
        text_color: 0xFFFFFF
        focused:
          bg_color: 0x00cc00
          border_color: 0xff0000
          bg_grad_dir: NONE
          border_width: 2
#==========================================================================================================================
  pages:
#==========================================================================================================================
    - id: air_quality_page # Should be the first page after power-up
      bg_color: 0x000000
      text_color: 0xFFFFFF
      widgets:
        - obj:
            align: TOP_MID
            styles: header_footer
            widgets:
              - label:
                  text: "Climate Sensors"
                  align: CENTER
                  text_align: CENTER
        - obj: # a properly placed coontainer object for all these controls
            text_color: 0xFFFFFF
            align: CENTER
            width: 320
            height: 180 #240-(2*30) #Display area less header & footer
            pad_all: 2
            bg_opa: TRANSP
            border_opa: TRANSP
            outline_width: 0 #debug
            scrollbar_mode: "OFF" #we don't want scrollbars displayed
            layout: # enable the GRID layout for the children widgets
              type: GRID # split the rows and the columns proportionally
              grid_columns: [FR(25), FR(4), FR(43), FR(8)] # equal
              grid_rows: [FR(1), FR(1), FR(1), FR(1), FR(1), FR(1), FR(1)] # like percents
              pad_row: 4
              pad_column: 2
            widgets:
            #-----------------------------------------------------
              - label:
                  grid_cell_column_pos: 0 # place the widget in
                  grid_cell_row_pos: 0 # the corresponding cell
                  grid_cell_y_align: CENTER
                  id: lbl_bar_pm10
                  text: PM10
              - label:
                  grid_cell_column_pos: 1 # place the widget in
                  grid_cell_row_pos: 0 # the corresponding cell
                  grid_cell_y_align: CENTER
                  text: 0 #scale label bar start
                  text_color: 0x808080 #Grey for bar dimension labels
              - bar: 
                  grid_cell_column_pos: 2 # place the widget in
                  grid_cell_row_pos: 0 # the corresponding cell
                  grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
                  grid_cell_y_align: STRETCH
                  id: bar_pm10
              - label:
                  grid_cell_column_pos: 3 # place the widget in
                  grid_cell_row_pos: 0 # the corresponding cell
                  grid_cell_y_align: CENTER
                  id: lbl_bar_pm10_max
                  text: "?" #scale lable bar end
                  text_color: 0x808080 #Grey for bar dimension labels
            #-----------------------------------------------------
              - label:
                  grid_cell_column_pos: 0 # place the widget in
                  grid_cell_row_pos: 1 # the corresponding cell
                  grid_cell_y_align: CENTER
                  id: lbl_bar_pm2_5
                  text: "PM2.5"
              - label:
                  grid_cell_column_pos: 1 # place the widget in
                  grid_cell_row_pos: 1 # the corresponding cell
                  grid_cell_y_align: CENTER
                  text: 0 #scale label bar start
                  text_color: 0x808080 #Grey for bar dimension labels
              - bar: 
                  grid_cell_column_pos: 2 # place the widget in
                  grid_cell_row_pos: 1 # the corresponding cell
                  grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
                  grid_cell_y_align: STRETCH
                  id: bar_pm2_5
              - label:
                  grid_cell_column_pos: 3 # place the widget in
                  grid_cell_row_pos: 1 # the corresponding cell
                  grid_cell_y_align: CENTER
                  id: lbl_bar_pm2_5_max
                  text: "?" #scale lable bar end
                  text_color: 0x808080 #Grey for bar dimension labels
            #-----------------------------------------------------
            #   - label:
            #       grid_cell_column_pos: 0 # place the widget in
            #       grid_cell_row_pos: 2 # the corresponding cell
            #       grid_cell_y_align: CENTER
            #       id: lbl_bar_no2
            #       text: NO2
            #   - label:
            #       grid_cell_column_pos: 1 # place the widget in
            #       grid_cell_row_pos: 2 # the corresponding cell
            #       grid_cell_y_align: CENTER
            #       text: 0 #scale label bar start
            #       text_color: 0x808080 #Grey for bar dimension labels
            #   - bar: 
            #       grid_cell_column_pos: 2 # place the widget in
            #       grid_cell_row_pos: 2 # the corresponding cell
            #       grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
            #       grid_cell_y_align: STRETCH
            #       id: bar_no2
            #   - label:
            #       grid_cell_column_pos: 3 # place the widget in
            #       grid_cell_row_pos: 2 # the corresponding cell
            #       grid_cell_y_align: CENTER
            #       id: lbl_bar_no2_max
            #       text: "?" #scale lable bar end
            #       text_color: 0x808080 #Grey for bar dimension labels
            # #-----------------------------------------------------
            #   - label:
            #       grid_cell_column_pos: 0 # place the widget in
            #       grid_cell_row_pos: 3 # the corresponding cell
            #       grid_cell_y_align: CENTER
            #       id: lbl_bar_co
            #       text: CO
            #   - label:
            #       grid_cell_column_pos: 1 # place the widget in
            #       grid_cell_row_pos: 3 # the corresponding cell
            #       grid_cell_y_align: CENTER
            #       text: 0 #scale label bar start
            #       text_color: 0x808080 #Grey for bar dimension labels
            #   - bar: 
            #         grid_cell_column_pos: 2 # place the widget in
            #         grid_cell_row_pos: 3 # the corresponding cell
            #         grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
            #         grid_cell_y_align: STRETCH
            #         id: bar_co
            #   - label:
            #       grid_cell_column_pos: 3 # place the widget in
            #       grid_cell_row_pos: 3 # the corresponding cell
            #       grid_cell_y_align: CENTER
            #       text_color: 0x808080 #Grey for bar dimension labels
            #       id: lbl_bar_co_max
            #       text: "?" #scale lable bar end
            #-----------------------------------------------------
              - label:
                  grid_cell_column_pos: 0 # place the widget in
                  grid_cell_row_pos: 4 # the corresponding cell
                  grid_cell_y_align: CENTER
                  id: lbl_bar_co2
                  text: CO2
              - label:
                  grid_cell_column_pos: 1 # place the widget in
                  grid_cell_row_pos: 4 # the corresponding cell
                  grid_cell_y_align: CENTER
                  text_color: 0x808080 #Grey for bar dimension labels
                  text: 0 #scale label bar start
              - bar: 
                  grid_cell_column_pos: 2 # place the widget in
                  grid_cell_row_pos: 4 # the corresponding cell
                  grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
                  grid_cell_y_align: STRETCH
                  id: bar_co2
              - label:
                  grid_cell_column_pos: 3 # place the widget in
                  grid_cell_row_pos: 4 # the corresponding cell
                  grid_cell_y_align: CENTER
                  text_color: 0x808080 #Grey for bar dimension labels
                  id: lbl_bar_co2_max
                  text: "?" #scale lable bar end
            #-----------------------------------------------------
              - label:
                  grid_cell_column_pos: 0 # place the widget in
                  grid_cell_row_pos: 5 # the corresponding cell
                  grid_cell_y_align: CENTER
                  id: lbl_bar_co2b
                  text: CO2
              - label:
                  grid_cell_column_pos: 1 # place the widget in
                  grid_cell_row_pos: 5 # the corresponding cell
                  grid_cell_y_align: CENTER
                  text_color: 0x808080 #Grey for bar dimension labels
                  text: 0 #scale label bar start
              - bar: 
                  grid_cell_column_pos: 2 # place the widget in
                  grid_cell_row_pos: 5 # the corresponding cell
                  grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
                  grid_cell_y_align: STRETCH
                  id: bar_co2b
              - label:
                  grid_cell_column_pos: 3 # place the widget in
                  grid_cell_row_pos: 5 # the corresponding cell
                  grid_cell_y_align: CENTER
                  text_color: 0x808080 #Grey for bar dimension labels
                  id: lbl_bar_co2b_max
                  text: "?" #scale lable bar end
            #-----------------------------------------------------
              # - label:
              #     grid_cell_column_pos: 0 # place the widget in
              #     grid_cell_row_pos: 6 # the corresponding cell
              #     grid_cell_y_align: CENTER
              #     id: lbl_bar_nh3
              #     text: NH3
              # - label:
              #     grid_cell_column_pos: 1 # place the widget in
              #     grid_cell_row_pos: 6 # the corresponding cell
              #     grid_cell_y_align: CENTER
              #     text_color: 0x808080 #Grey for bar dimension labels
              #     text: 0 #scale label bar start
              # - bar: 
              #     grid_cell_column_pos: 2 # place the widget in
              #     grid_cell_row_pos: 6 # the corresponding cell
              #     grid_cell_x_align: STRETCH #Have to use STRETCH so that bar size is adjusted to cell size
              #     grid_cell_y_align: STRETCH
              #     id: bar_nh3
              # - label:
              #     grid_cell_column_pos: 3 # place the widget in
              #     grid_cell_row_pos: 6 # the corresponding cell
              #     grid_cell_y_align: CENTER
              #     text_color: 0x808080 #Grey for bar dimension labels
              #     id: lbl_bar_nh3_max
              #     text: "?" #scale lable bar end
#--------------------------------------------------------------------------

#==========================================================================================================================
    - id: climate_clock_page
      # bg_color: 0x000000
      # text_color: 0xFFFFFF
      widgets:
        - obj:
            align: TOP_MID
            styles: header_footer
            widgets:
              - label:
                  text: "Climate Clock"
                  align: CENTER
                  text_align: CENTER
        - label:
            x: 0
            y: 50
            width: 320
            text_font: font_roboto_medium22 # Bigger text
            text_color: 0x00FFFF
            id: lbl_scrolling_news
            long_mode: SCROLL_CIRCULAR
            text: "News ticker"
        
